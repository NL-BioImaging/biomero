<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>biomero.slurm_client &mdash; BIOMERO 1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BIOMERO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">BIOMERO - Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html">BIOMERO - BioImage analysis in OMERO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#overview">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#quickstart">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#prerequisites-getting-started-with-biomero">Prerequisites &amp; Getting Started with BIOMERO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#biomero-scripts">BIOMERO scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#docker-containers">(Docker) containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#see-the-tutorials">See the tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#ssh">SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#slurmclient-class">SlurmClient class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#slurm-config-ini">slurm-config.ini</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#how-to-add-an-existing-workflow">How to add an existing workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#how-to-add-your-new-custom-workflow">How to add your new custom workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#slurm-jobs">Slurm jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#batching">Batching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#using-the-gpu-on-slurm">Using the GPU on Slurm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#transfering-data">Transfering data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#testing-the-python-code">Testing the Python code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#logging">Logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_link.html">Cellprofiler tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_link.html#cellexpansion-tutorial">CellExpansion tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_link.html#local-slurm-tutorial">Local Slurm tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_link.html#google-cloud-slurm-tutorial">Google Cloud Slurm tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_link.html#microsoft-azure-slurm-tutorial">Microsoft Azure Slurm tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_link.html#extra-thoughts">Extra thoughts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">biomero</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BIOMERO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">biomero.slurm_client</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for biomero.slurm_client</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Copyright 2023 Torec Luik</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">fabric</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">fabric.transfer</span> <span class="kn">import</span> <span class="n">Result</span> <span class="k">as</span> <span class="n">TransferResult</span>
<span class="kn">from</span> <span class="nn">invoke.exceptions</span> <span class="kn">import</span> <span class="n">UnexpectedExit</span>
<span class="kn">from</span> <span class="nn">paramiko</span> <span class="kn">import</span> <span class="n">SSHException</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests_cache</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>
<span class="kn">from</span> <span class="nn">urllib3.util</span> <span class="kn">import</span> <span class="n">Retry</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">timesleep</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">importlib_resources</span> <span class="kn">import</span> <span class="n">files</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SlurmJob"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmJob">[docs]</a><span class="k">class</span> <span class="nc">SlurmJob</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a job submitted to a Slurm cluster.</span>

<span class="sd">    This class encapsulates information and methods related to managing a job</span>
<span class="sd">    submitted to a Slurm cluster. It provides functionality to monitor the</span>
<span class="sd">    job&#39;s state, wait for completion, and perform cleanup operations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        job_id (int): The ID of the Slurm job.</span>
<span class="sd">        submit_result (Result): The result of submitting the job.</span>
<span class="sd">        ok (bool): Indicates whether the job submission was successful.</span>
<span class="sd">        job_state (str): The current state of the Slurm job.</span>
<span class="sd">        error_message (str): The error message, if any.</span>

<span class="sd">    Args:</span>
<span class="sd">        submit_result (Result): The result of submitting the job.</span>
<span class="sd">        job_id (int): The Slurm job ID.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Submit some job with the SlurmClient</span>
<span class="sd">        submit_result, job_id = slurmClient.run_workflow(</span>
<span class="sd">            workflow_name, workflow_version, input_data, email, time, **kwargs)</span>
<span class="sd">            </span>
<span class="sd">        # Create a SlurmJob instance</span>
<span class="sd">        slurmJob = SlurmJob(submit_result, job_id)</span>

<span class="sd">        if not slurmJob.ok:</span>
<span class="sd">            logger.warning(f&quot;Error with job: {slurmJob.get_error()}&quot;)</span>
<span class="sd">        else:</span>
<span class="sd">            try:</span>
<span class="sd">                slurmJob.wait_for_completion(slurmClient, conn)</span>
<span class="sd">                if not slurmJob.completed():</span>
<span class="sd">                    raise Exception(f&quot;Job is not completed: {slurmJob}&quot;)</span>
<span class="sd">                else:</span>
<span class="sd">                    slurmJob.cleanup(slurmClient)</span>
<span class="sd">            except Exception as e:</span>
<span class="sd">                logger.error(f&quot; ERROR WITH JOB: {e}&quot;)</span>
<span class="sd">                raise e</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">submit_result</span><span class="p">:</span> <span class="n">Result</span><span class="p">,</span>
                 <span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a SlurmJob instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            submit_result (Result): The result of submitting the job.</span>
<span class="sd">            job_id (int): The Slurm job ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_result</span> <span class="o">=</span> <span class="n">submit_result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_result</span><span class="o">.</span><span class="n">ok</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_result</span><span class="o">.</span><span class="n">stderr</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_result</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

<div class="viewcode-block" id="SlurmJob.wait_for_completion"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmJob.wait_for_completion">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slurmClient</span><span class="p">,</span> <span class="n">omeroConn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the Slurm job to reach completion, cancellation, failure, or timeout.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurmClient: The Slurm client.</span>
<span class="sd">            omeroConn: The OMERO connection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The final state of the Slurm job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> 
                                     <span class="s2">&quot;COMPLETED&quot;</span><span class="p">,</span> 
                                     <span class="s2">&quot;CANCELLED&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;FAILED+&quot;</span><span class="p">,</span> 
                                     <span class="s2">&quot;COMPLETED+&quot;</span><span class="p">,</span> 
                                     <span class="s2">&quot;CANCELLED+&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;TIMEOUT+&quot;</span><span class="p">):</span>
            <span class="n">job_status_dict</span><span class="p">,</span> <span class="n">poll_result</span> <span class="o">=</span> <span class="n">slurmClient</span><span class="o">.</span><span class="n">check_job_status</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">poll_result</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error checking job status:</span><span class="si">{poll_result.stderr}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span> <span class="o">=</span> <span class="n">poll_result</span><span class="o">.</span><span class="n">stderr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span> <span class="o">=</span> <span class="n">job_status_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">]</span>
            <span class="c1"># wait for 10 seconds before checking again</span>
            <span class="n">omeroConn</span><span class="o">.</span><span class="n">keepAlive</span><span class="p">()</span>  <span class="c1"># keep the OMERO connection alive</span>
            <span class="n">timesleep</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{self.job_id}</span><span class="s2"> finished: </span><span class="si">{self.job_state}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;You can get the logfile using `Slurm Get Update` on job </span><span class="si">{self.job_id}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span></div>
    
<div class="viewcode-block" id="SlurmJob.cleanup"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmJob.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slurmClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup remaining log files.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurmClient: The Slurm client.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the cleanup operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">slurmClient</span><span class="o">.</span><span class="n">cleanup_tmp_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmJob.completed"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmJob.completed">[docs]</a>    <span class="k">def</span> <span class="nf">completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the Slurm job has completed successfully.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the job has completed; False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span> <span class="o">==</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_state</span> <span class="o">==</span> <span class="s2">&quot;COMPLETED+&quot;</span></div>
    
<div class="viewcode-block" id="SlurmJob.get_error"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmJob.get_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the error message associated with the Slurm job submission.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The error message, or an empty string if no error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_message</span></div>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representation of the SlurmJob instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: String representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{key}</span><span class="s2">=</span><span class="si">{value}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;SlurmJob(</span><span class="si">{properties}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="SlurmClient"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient">[docs]</a><span class="k">class</span> <span class="nc">SlurmClient</span><span class="p">(</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A client for connecting to and interacting with a Slurm cluster over</span>
<span class="sd">    SSH.</span>

<span class="sd">    This class extends the Connection class, adding methods and</span>
<span class="sd">    attributes specific to working with Slurm.</span>

<span class="sd">    SlurmClient accepts the same arguments as Connection. Below only</span>
<span class="sd">    mentions the added ones:</span>

<span class="sd">    The easiest way to set this client up is by using a slurm-config.ini</span>
<span class="sd">    and the from_config() method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        slurm_data_path (str): The path to the directory containing the</span>
<span class="sd">            data files for Slurm jobs.</span>
<span class="sd">        slurm_images_path (str): The path to the directory containing</span>
<span class="sd">            the Singularity images for Slurm jobs.</span>
<span class="sd">        slurm_converters_path (str): The path to the directory containing</span>
<span class="sd">            the Singularity images for file converters.</span>
<span class="sd">        slurm_model_paths (dict): A dictionary containing the paths to</span>
<span class="sd">            the Singularity images for specific Slurm job models.</span>
<span class="sd">        slurm_model_repos (dict): A dictionary containing the git</span>
<span class="sd">            repositories of Singularity images for specific Slurm job models.</span>
<span class="sd">        slurm_model_images (dict): A dictionary containing the dockerhub</span>
<span class="sd">            of the Singularity images for specific Slurm job models.</span>
<span class="sd">            Will fill automatically from the data in the git repository,</span>
<span class="sd">            if you set init_slurm.</span>
<span class="sd">        slurm_script_path (str): The path to the directory containing</span>
<span class="sd">            the Slurm job submission scripts on Slurm.</span>
<span class="sd">        slurm_script_repo (str): The git https URL for cloning the repo</span>
<span class="sd">            containing the Slurm job submission scripts. Optional.</span>

<span class="sd">    Example:</span>
<span class="sd">        # Create a SlurmClient object as contextmanager</span>

<span class="sd">        with SlurmClient.from_config() as client:</span>

<span class="sd">            # Run a command on the remote host</span>

<span class="sd">            result = client.run(&#39;sbatch myjob.sh&#39;)</span>

<span class="sd">            # Check whether the command succeeded</span>

<span class="sd">            if result.ok:</span>
<span class="sd">                print(&#39;Job submitted successfully!&#39;)</span>

<span class="sd">            # Print the output of the command</span>

<span class="sd">            print(result.stdout)</span>

<span class="sd">    Example 2:</span>
<span class="sd">        # Create a SlurmClient and setup Slurm (download containers etc.)</span>

<span class="sd">        with SlurmClient.from_config(init_slurm=True) as client:</span>

<span class="sd">            client.run_workflow(...)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_DEFAULT_CONFIG_PATH_1</span> <span class="o">=</span> <span class="s2">&quot;/etc/slurm-config.ini&quot;</span>
    <span class="n">_DEFAULT_CONFIG_PATH_2</span> <span class="o">=</span> <span class="s2">&quot;~/slurm-config.ini&quot;</span>
    <span class="n">_DEFAULT_HOST</span> <span class="o">=</span> <span class="s2">&quot;slurm&quot;</span>
    <span class="n">_DEFAULT_INLINE_SSH_ENV</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_DEFAULT_SLURM_DATA_PATH</span> <span class="o">=</span> <span class="s2">&quot;my-scratch/data&quot;</span>
    <span class="n">_DEFAULT_SLURM_IMAGES_PATH</span> <span class="o">=</span> <span class="s2">&quot;my-scratch/singularity_images/workflows&quot;</span>
    <span class="n">_DEFAULT_SLURM_CONVERTERS_PATH</span> <span class="o">=</span> <span class="s2">&quot;my-scratch/singularity_images/converters&quot;</span>
    <span class="n">_DEFAULT_SLURM_GIT_SCRIPT_PATH</span> <span class="o">=</span> <span class="s2">&quot;slurm-scripts&quot;</span>
    <span class="n">_OUT_SEP</span> <span class="o">=</span> <span class="s2">&quot;--split--&quot;</span>
    <span class="n">_VERSION_CMD</span> <span class="o">=</span> <span class="s2">&quot;ls -h </span><span class="se">\&quot;</span><span class="si">{slurm_images_path}</span><span class="s2">/</span><span class="si">{image_path}</span><span class="se">\&quot;</span><span class="s2"> | grep -oP &#39;(?&lt;=\-|\_)(v.+|latest)(?=.simg|.sif)&#39;&quot;</span>
    <span class="n">_CONVERTER_VERSION_CMD</span> <span class="o">=</span> <span class="s2">&quot;ls -h </span><span class="se">\&quot;</span><span class="si">{converter_path}</span><span class="se">\&quot;</span><span class="s2"> | grep -oP &#39;(convert_.+)(?=.simg|.sif)&#39; | awk &#39;{{n=split($0, a, </span><span class="se">\&quot;</span><span class="s2">_</span><span class="se">\&quot;</span><span class="s2">); last=a[n]; sub(</span><span class="se">\&quot;</span><span class="s2">_</span><span class="se">\&quot;</span><span class="s2">last</span><span class="se">\&quot;</span><span class="s2">$</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;\&quot;</span><span class="s2">, $0); print $0, last}}&#39;&quot;</span>
    <span class="c1"># Note, grep returns exitcode 1 if no match is found!</span>
    <span class="c1"># This will translate into a UnexpectedExit error, so mute that if you</span>
    <span class="c1"># don&#39;t care about empty.</span>
    <span class="c1"># Like below with the &quot;|| :&quot;.</span>
    <span class="c1"># Data could legit be empty.</span>
    <span class="n">_DATA_CMD</span> <span class="o">=</span> <span class="s2">&quot;ls -h </span><span class="se">\&quot;</span><span class="si">{slurm_data_path}</span><span class="se">\&quot;</span><span class="s2"> | grep -oP &#39;.+(?=.zip)&#39; || :&quot;</span>
    <span class="n">_ALL_JOBS_CMD</span> <span class="o">=</span> <span class="s2">&quot;sacct --starttime </span><span class="si">{start_time}</span><span class="s2"> --endtime </span><span class="si">{end_time}</span><span class="s2"> --state </span><span class="si">{states}</span><span class="s2"> -o </span><span class="si">{columns}</span><span class="s2"> -n -X &quot;</span>
    <span class="n">_ZIP_CMD</span> <span class="o">=</span> <span class="s2">&quot;7z a -y </span><span class="se">\&quot;</span><span class="si">{filename}</span><span class="se">\&quot;</span><span class="s2"> -tzip </span><span class="se">\&quot;</span><span class="si">{data_location}</span><span class="s2">/data/out</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
    <span class="n">_ACTIVE_JOBS_CMD</span> <span class="o">=</span> <span class="s2">&quot;squeue -u $USER --nohead --format </span><span class="si">%F</span><span class="s2">&quot;</span>
    <span class="n">_JOB_STATUS_CMD</span> <span class="o">=</span> <span class="s2">&quot;sacct -n -o JobId,State,End -X -j </span><span class="si">{slurm_job_id}</span><span class="s2">&quot;</span>
    <span class="c1"># TODO move all commands to a similar format.</span>
    <span class="c1"># Then maybe allow overwrite from slurm-config.ini</span>
    <span class="n">_LOGFILE</span> <span class="o">=</span> <span class="s2">&quot;omero-</span><span class="si">{slurm_job_id}</span><span class="s2">.log&quot;</span>
    <span class="n">_CONVERTER_LOGFILE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">slurm-</span><span class="si">{slurm_job_id}</span><span class="se">\&quot;</span><span class="s2">_*.out&quot;</span>
    <span class="n">_TAIL_LOG_CMD</span> <span class="o">=</span> <span class="s2">&quot;tail -n </span><span class="si">{n}</span><span class="s2"> </span><span class="se">\&quot;</span><span class="si">{log_file}</span><span class="se">\&quot;</span><span class="s2"> | strings&quot;</span>
    <span class="n">_LOGFILE_DATA_CMD</span> <span class="o">=</span> <span class="s2">&quot;cat </span><span class="se">\&quot;</span><span class="si">{log_file}</span><span class="se">\&quot;</span><span class="s2"> | perl -wne &#39;/Running [\w-]+? Job w\/ .+? \| .+? \| (.+?) \|.*/i and print$1&#39;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="n">_DEFAULT_HOST</span><span class="p">,</span>
                 <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gateway</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">forward_agent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">connect_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">connect_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">inline_ssh_env</span><span class="o">=</span><span class="n">_DEFAULT_INLINE_SSH_ENV</span><span class="p">,</span>
                 <span class="n">slurm_data_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_SLURM_DATA_PATH</span><span class="p">,</span>
                 <span class="n">slurm_images_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_SLURM_IMAGES_PATH</span><span class="p">,</span>
                 <span class="n">slurm_converters_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_SLURM_CONVERTERS_PATH</span><span class="p">,</span>
                 <span class="n">slurm_model_paths</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">slurm_model_repos</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">slurm_model_images</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">converter_images</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">slurm_model_jobs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">slurm_model_jobs_params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">slurm_script_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_DEFAULT_SLURM_GIT_SCRIPT_PATH</span><span class="p">,</span>
                 <span class="n">slurm_script_repo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_slurm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a new instance of the SlurmClient class.</span>

<span class="sd">        It is preferable to use #from_config(...) method to initialize</span>
<span class="sd">        parameters from a config file.</span>

<span class="sd">        Args:</span>
<span class="sd">            host (str, optional): The hostname or IP address of the remote</span>
<span class="sd">                server. Defaults to _DEFAULT_HOST.</span>
<span class="sd">            user (str, optional): The username to use when connecting to </span>
<span class="sd">                the remote server. Defaults to None, which defaults </span>
<span class="sd">                to config.user.</span>
<span class="sd">            port (int, optional): The SSH port to use when connecting.</span>
<span class="sd">                Defaults to None, which defaults to config.port.</span>
<span class="sd">            config (str, optional): Path to the SSH config file.</span>
<span class="sd">                Defaults to None, which defaults to your SSH config file.</span>
<span class="sd">            gateway (Connection, optional): An optional gateway for connecting </span>
<span class="sd">                through a jump host. Defaults to None.</span>
<span class="sd">            forward_agent (bool, optional): Whether to forward the local SSH </span>
<span class="sd">                agent to the remote server. Defaults to None, which </span>
<span class="sd">                defaults to config.forward_agent.</span>
<span class="sd">            connect_timeout (int, optional): Timeout for establishing the SSH </span>
<span class="sd">                connection. Defaults to None, which defaults </span>
<span class="sd">                to config.timeouts.connect.</span>
<span class="sd">            connect_kwargs (dict, optional): Additional keyword arguments for </span>
<span class="sd">                the underlying SSH connection. Handed verbatim to </span>
<span class="sd">                `SSHClient.connect &lt;paramiko.client.SSHClient.connect&gt;`. </span>
<span class="sd">                Defaults to None. </span>
<span class="sd">            inline_ssh_env (bool, optional): Whether to use inline SSH</span>
<span class="sd">                environment. This is necessary if the remote server has </span>
<span class="sd">                a restricted ``AcceptEnv`` setting (which is the common </span>
<span class="sd">                default). Defaults to _DEFAULT_INLINE_SSH_ENV.</span>
<span class="sd">            slurm_data_path (str, optional): The path to the directory</span>
<span class="sd">                containing the data files for Slurm jobs.</span>
<span class="sd">                Defaults to _DEFAULT_SLURM_DATA_PATH.</span>
<span class="sd">            slurm_images_path (str, optional): The path to the directory</span>
<span class="sd">                containing the Singularity images for Slurm jobs.</span>
<span class="sd">                Defaults to _DEFAULT_SLURM_IMAGES_PATH.</span>
<span class="sd">            slurm_converters_path (str, optional): The path to the directory</span>
<span class="sd">                containing the Singularity images for file converters.</span>
<span class="sd">                Defaults to _DEFAULT_SLURM_CONVERTERS_PATH.</span>
<span class="sd">            slurm_model_paths (dict, optional): A dictionary containing the </span>
<span class="sd">                paths to the Singularity images for specific Slurm job models.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            slurm_model_repos (dict, optional): A dictionary containing the </span>
<span class="sd">                git repositories of Singularity images for specific Slurm </span>
<span class="sd">                job models.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            slurm_model_images (dict, optional): A dictionary containing the </span>
<span class="sd">                dockerhub of the Singularity images for specific Slurm </span>
<span class="sd">                job models. Will fill automatically from the data in the git </span>
<span class="sd">                repository if you set init_slurm.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            converter_images (dict, optional): A dictionairy containing the</span>
<span class="sd">                dockerhub of the Singularity images for converters. </span>
<span class="sd">                Will default to building converter available in this package</span>
<span class="sd">                on Slurm instead if not configured.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            slurm_model_jobs (dict, optional): A dictionary containing</span>
<span class="sd">                information about specific Slurm job models.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            slurm_model_jobs_params (dict, optional): A dictionary containing</span>
<span class="sd">                parameters for specific Slurm job models.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            slurm_script_path (str, optional): The path to the directory</span>
<span class="sd">                containing the Slurm job submission scripts on Slurm.</span>
<span class="sd">                Defaults to _DEFAULT_SLURM_GIT_SCRIPT_PATH.</span>
<span class="sd">            slurm_script_repo (str, optional): The git https URL for cloning</span>
<span class="sd">                the repo containing the Slurm job submission scripts.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            init_slurm (bool): Whether to set up the required structures </span>
<span class="sd">                on Slurm after initiating this client. This includes creating </span>
<span class="sd">                missing folders, downloading container images, cloning git,etc.</span>
<span class="sd">                This will take a while at first but will validate your setup.</span>
<span class="sd">                Defaults to False to save time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SlurmClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
                                          <span class="n">user</span><span class="p">,</span>
                                          <span class="n">port</span><span class="p">,</span>
                                          <span class="n">config</span><span class="p">,</span>
                                          <span class="n">gateway</span><span class="p">,</span>
                                          <span class="n">forward_agent</span><span class="p">,</span>
                                          <span class="n">connect_timeout</span><span class="p">,</span>
                                          <span class="n">connect_kwargs</span><span class="p">,</span>
                                          <span class="n">inline_ssh_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_data_path</span> <span class="o">=</span> <span class="n">slurm_data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span> <span class="o">=</span> <span class="n">slurm_images_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span> <span class="o">=</span> <span class="n">slurm_converters_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span> <span class="o">=</span> <span class="n">slurm_model_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_path</span> <span class="o">=</span> <span class="n">slurm_script_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_repo</span> <span class="o">=</span> <span class="n">slurm_script_repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_repos</span> <span class="o">=</span> <span class="n">slurm_model_repos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span> <span class="o">=</span> <span class="n">slurm_model_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converter_images</span> <span class="o">=</span> <span class="n">converter_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_jobs</span> <span class="o">=</span> <span class="n">slurm_model_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_jobs_params</span> <span class="o">=</span> <span class="n">slurm_model_jobs_params</span>

        <span class="c1"># Init cache. Keep responses for 360 seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">SQLiteCache</span><span class="p">(</span>
            <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;github_cache&quot;</span><span class="p">,</span> <span class="n">use_temp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_github_session</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_workflows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validate_slurm_setup</span><span class="o">=</span><span class="n">init_slurm</span><span class="p">)</span>

<div class="viewcode-block" id="SlurmClient.init_workflows"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.init_workflows">[docs]</a>    <span class="k">def</span> <span class="nf">init_workflows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the required info for the configured workflows from github.</span>
<span class="sd">        It will fill `slurm_model_images` with dockerhub links.</span>

<span class="sd">        Args:</span>
<span class="sd">            force_update (bool): Will overwrite already given paths</span>
<span class="sd">                in `slurm_model_images`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_repos</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No workflows configured!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_repos</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># skips the setup</span>
        <span class="k">for</span> <span class="n">workflow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_repos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">workflow</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span> <span class="ow">or</span> <span class="n">force_update</span><span class="p">:</span>
                <span class="n">json_descriptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pull_descriptor_from_github</span><span class="p">(</span><span class="n">workflow</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">json_descriptor</span><span class="p">)</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">json_descriptor</span><span class="p">[</span><span class="s1">&#39;container-image&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span><span class="p">[</span><span class="n">workflow</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span></div>

<div class="viewcode-block" id="SlurmClient.setup_slurm"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.setup_slurm">[docs]</a>    <span class="k">def</span> <span class="nf">setup_slurm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates or creates the required setup on the Slurm cluster.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: if it cannot connect to Slurm, or runs into an error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="c1"># 1. Create directories</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_directories</span><span class="p">()</span>

            <span class="c1"># 2. Clone git</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_job_scripts</span><span class="p">()</span>

            <span class="c1"># 3. Setup converters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_converters</span><span class="p">()</span>

            <span class="c1"># 4. Download workflow images</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_container_images</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="s2">&quot;Failure in connecting to Slurm cluster&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.setup_container_images"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.setup_container_images">[docs]</a>    <span class="k">def</span> <span class="nf">setup_container_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up container images for Slurm operations.</span>

<span class="sd">        This function creates specific directories for container images and pulls</span>
<span class="sd">        necessary images from Docker repositories. It generates and executes</span>
<span class="sd">        a script to pull images and copies it to the remote location.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If there is an issue executing commands or copying files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create specific workflow dirs</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="p">:</span>
                <span class="n">modelpaths</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="c1"># mkdir cellprofiler imagej ...</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">{modelpaths}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span><span class="p">:</span>
                <span class="n">pull_commands</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">wf</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_repos</span><span class="p">[</span><span class="n">wf</span><span class="p">]</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="p">[</span><span class="n">wf</span><span class="p">]</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_parts_from_url</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span><span class="p">:</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;latest&quot;</span>
                    <span class="n">pull_template</span> <span class="o">=</span> <span class="s2">&quot;echo &#39;starting $path $version&#39; &gt;&gt; sing.log</span><span class="se">\n</span><span class="s2">nohup sh -c </span><span class="se">\&quot;</span><span class="s2">singularity pull --disable-cache --dir $path docker://$image:$version; echo &#39;finished $path $version&#39;</span><span class="se">\&quot;</span><span class="s2"> &gt;&gt; sing.log 2&gt;&amp;1 &amp; disown&quot;</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">pull_template</span><span class="p">)</span>
                    <span class="n">substitutes</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">substitutes</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;substituted: </span><span class="si">{cmd}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">pull_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="n">script_name</span> <span class="o">=</span> <span class="s2">&quot;pull_images.sh&quot;</span>
                <span class="n">template_script</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">template_script</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">substitute</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pullcommands&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pull_commands</span><span class="p">)}</span>
                    <span class="n">job_script</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">substitute</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;substituted:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{job_script}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># copy to remote file</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">script_name</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">job_script</span><span class="p">),</span>
                             <span class="n">remote</span><span class="o">=</span><span class="n">full_path</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;time sh </span><span class="si">{script_name}</span><span class="s2">&quot;</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initiated downloading and building&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot; container images on Slurm.&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot; This will probably take a while in the background.&quot;</span> <span class="o">+</span> 
                            <span class="s2">&quot; Check &#39;sing.log&#39; on Slurm for progress.&quot;</span><span class="p">)</span></div>
                <span class="c1"># # cleanup giant singularity cache!</span>
                <span class="c1"># using --disable-cache because we run in the background</span>
                <span class="c1"># cmd = &quot;singularity cache clean -f&quot;</span>
                <span class="c1"># r = self.run_commands([cmd])</span>

<div class="viewcode-block" id="SlurmClient.list_available_converter_versions"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.list_available_converter_versions">[docs]</a>    <span class="k">def</span> <span class="nf">list_available_converter_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note, assumes you use versioned converters.</span>
<span class="sd">        Will return a dict with a version of each converter on your Slurm.</span>
<span class="sd">        However, doesn&#39;t work properly with unversioned sif.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONVERTER_VERSION_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">converter_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">])</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="c1"># Iterate over each line in the output</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="c1"># Split the line into key and version</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>                
                <span class="c1"># Check if the key already exists in the dictionary</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result_dict</span><span class="p">:</span>
                    <span class="c1"># Append the version to the existing list</span>
                    <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create a new list with the version</span>
                    <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">version</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result_dict</span></div>
        
<div class="viewcode-block" id="SlurmClient.setup_converters"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.setup_converters">[docs]</a>    <span class="k">def</span> <span class="nf">setup_converters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up converters for Slurm operations.</span>

<span class="sd">        This function creates necessary directories for converters and copies</span>
<span class="sd">        converter scripts and definitions to the appropriate locations. It also</span>
<span class="sd">        builds Singularity containers from the provided definitions.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If there is an issue executing commands or copying files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">convert_cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">:</span>
            <span class="n">convert_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">{self.slurm_converters_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">convert_cmds</span><span class="p">)</span>
        
        <span class="c1"># copy generic job array script over to slurm</span>
        <span class="n">convert_job_local</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="s2">&quot;convert_job_array.sh&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">convert_job_local</span><span class="p">,</span>
                    <span class="n">remote</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_path</span><span class="p">)</span>
        
        <span class="c1">## PULL converter if provided in config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter_images</span><span class="p">:</span>
            <span class="n">pull_commands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">version</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_docker_image_version</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
                    <span class="n">chosen_converter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;convert_</span><span class="si">{path}</span><span class="s2">_</span><span class="si">{version}</span><span class="s2">.sif&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;latest&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pulling &#39;latest&#39; as no version was provided for </span><span class="si">{image}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">chosen_converter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;convert_</span><span class="si">{path}</span><span class="s2">_latest.sif&quot;</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">):</span>
                    <span class="n">pull_template</span> <span class="o">=</span> <span class="s2">&quot;echo &#39;starting $path $version&#39; &gt;&gt; sing.log</span><span class="se">\n</span><span class="s2">nohup sh -c </span><span class="se">\&quot;</span><span class="s2">singularity pull --force --disable-cache $conv_name docker://$image:$version; echo &#39;finished $path $version&#39;</span><span class="se">\&quot;</span><span class="s2"> &gt;&gt; sing.log 2&gt;&amp;1 &amp; disown&quot;</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">pull_template</span><span class="p">)</span>
                    <span class="n">substitutes</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
                    <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;conv_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_converter</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">substitutes</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;substituted: </span><span class="si">{cmd}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">pull_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="s2">&quot;pull_images.sh&quot;</span>
            <span class="n">template_script</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">template_script</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">substitute</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pullcommands&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pull_commands</span><span class="p">)}</span>
                <span class="n">job_script</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">substitute</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;substituted:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{job_script}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># copy to remote file</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">script_name</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">job_script</span><span class="p">),</span> <span class="n">remote</span><span class="o">=</span><span class="n">full_path</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;time sh </span><span class="si">{script_name}</span><span class="s2">&quot;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initiated downloading and building&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot; container images on Slurm.&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot; This will probably take a while in the background.&quot;</span> <span class="o">+</span> 
                            <span class="s2">&quot; Check &#39;sing.log&#39; on Slurm for progress.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## BUILD converter from singularity def file</span>
            <span class="c1"># currently known converters</span>
            <span class="c1"># 3a. ZARR to TIFF</span>
            <span class="c1"># TODO extract these values to e.g. config if we have more</span>
            <span class="n">convert_name</span> <span class="o">=</span> <span class="s2">&quot;convert_zarr_to_tiff&quot;</span>
            <span class="n">convert_py</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{convert_name}</span><span class="s2">.py&quot;</span>
            <span class="n">convert_script_local</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="n">convert_py</span><span class="p">)</span>
            <span class="n">convert_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{convert_name}</span><span class="s2">.def&quot;</span>
            <span class="n">convert_def_local</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="n">convert_def</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">convert_script_local</span><span class="p">,</span>
                        <span class="n">remote</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">convert_def_local</span><span class="p">,</span>
                        <span class="n">remote</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">)</span>
            <span class="c1"># Build singularity container from definition</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_converters_path</span><span class="p">):</span>
                <span class="n">convert_cmds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span><span class="p">:</span>
                    <span class="c1"># TODO Change the tmp dir?</span>
                    <span class="c1"># export SINGULARITY_TMPDIR=~/my-scratch/tmp;</span>
                    <span class="c1"># only if file does not exist yet</span>
                    <span class="c1"># convert_cmds.append(f&quot;[ ! -f {convert_name}.sif ]&quot;)</span>
                    <span class="c1"># EDIT -- NO, then we can&#39;t update! Force rebuild!</span>
                    <span class="c1"># download /build new container</span>
                    <span class="n">convert_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;singularity build -F </span><span class="se">\&quot;</span><span class="si">{convert_name}</span><span class="s2">_latest.sif</span><span class="se">\&quot;</span><span class="s2"> </span><span class="si">{convert_def}</span><span class="s2"> &gt;&gt; sing.log 2&gt;&amp;1 ; echo &#39;finished </span><span class="si">{convert_name}</span><span class="s2">_latest.sif&#39; &amp;&quot;</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">convert_cmds</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.setup_job_scripts"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.setup_job_scripts">[docs]</a>    <span class="k">def</span> <span class="nf">setup_job_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up job scripts for Slurm operations.</span>

<span class="sd">        This function either clones a Git repository containing job scripts</span>
<span class="sd">        into the specified script path or generates scripts locally if no repository</span>
<span class="sd">        is provided.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If there is an issue executing Git commands or generating scripts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_repo</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_path</span><span class="p">:</span>
            <span class="c1"># git clone into script path</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;REPOSRC&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_script_repo}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LOCALREPO&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_script_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="p">}</span>
            <span class="c1"># Cleanup the existing folder first</span>
            <span class="n">cleanup_first</span> <span class="o">=</span> <span class="s1">&#39;rm -rf &quot;$LOCALREPO&quot;&#39;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;git clone &quot;$REPOSRC&quot; &quot;$LOCALREPO&quot; 2&gt; /dev/null&#39;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cleanup_first</span><span class="p">,</span> <span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_path</span><span class="p">:</span>
            <span class="c1"># generate scripts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_slurm_scripts</span><span class="p">(</span><span class="n">generate_jobs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.setup_directories"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.setup_directories">[docs]</a>    <span class="k">def</span> <span class="nf">setup_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates necessary directories for Slurm operations.</span>

<span class="sd">        This function creates directories for data storage, scripts, and workflows</span>
<span class="sd">        as specified in the SlurmClient object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If there is an issue executing directory creation commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># a. data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_data_path</span><span class="p">:</span>
            <span class="n">dir_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># b. scripts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_path</span><span class="p">:</span>
            <span class="n">dir_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">{self.slurm_script_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># c. workflows</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span><span class="p">:</span>
            <span class="n">dir_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">{self.slurm_images_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">dir_cmds</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.from_config"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">configfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">init_slurm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SlurmClient&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a new SlurmClient object using the parameters read from a</span>
<span class="sd">        configuration file (.ini).</span>

<span class="sd">        Defaults paths to look for config files are:</span>
<span class="sd">            - /etc/slurm-config.ini</span>
<span class="sd">            - ~/slurm-config.ini</span>

<span class="sd">        Note that this is only for the SLURM specific values that we added.</span>
<span class="sd">        Most configuration values are set via configuration mechanisms from</span>
<span class="sd">        Fabric library,</span>
<span class="sd">        like SSH settings being loaded from SSH config, /etc/fabric.yml or</span>
<span class="sd">        environment variables.</span>
<span class="sd">        See Fabric&#39;s documentation for more info on configuration if needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            configfile (str): The path to your configuration file. Optional.</span>
<span class="sd">            init_slurm (bool): Initiate / validate slurm setup. Optional</span>
<span class="sd">                Might take some time the first time with downloading etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SlurmClient: A new SlurmClient object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load the configuration file</span>
        <span class="n">configs</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span><span class="n">allow_no_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Loads from default locations and given location, missing files are ok</span>
        <span class="n">configs</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_CONFIG_PATH_1</span><span class="p">,</span>
                     <span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_CONFIG_PATH_2</span><span class="p">,</span>
                     <span class="n">configfile</span><span class="p">])</span>
        <span class="c1"># Read the required parameters from the configuration file,</span>
        <span class="c1"># fallback to defaults</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SSH&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_HOST</span><span class="p">)</span>
        <span class="n">inline_ssh_env</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span>
            <span class="s2">&quot;SSH&quot;</span><span class="p">,</span> <span class="s2">&quot;inline_ssh_env&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_INLINE_SSH_ENV</span><span class="p">)</span>
        <span class="n">slurm_data_path</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;SLURM&quot;</span><span class="p">,</span> <span class="s2">&quot;slurm_data_path&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_SLURM_DATA_PATH</span><span class="p">)</span>
        <span class="n">slurm_images_path</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;SLURM&quot;</span><span class="p">,</span> <span class="s2">&quot;slurm_images_path&quot;</span><span class="p">,</span>
            <span class="n">fallback</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_SLURM_IMAGES_PATH</span><span class="p">)</span>
        <span class="n">slurm_converters_path</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;SLURM&quot;</span><span class="p">,</span> <span class="s2">&quot;slurm_converters_path&quot;</span><span class="p">,</span>
            <span class="n">fallback</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_SLURM_CONVERTERS_PATH</span><span class="p">)</span>

        <span class="c1"># Split the MODELS into paths, repos and images</span>
        <span class="n">models_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s2">&quot;MODELS&quot;</span><span class="p">))</span>
        <span class="n">slurm_model_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">slurm_model_repos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">slurm_model_jobs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">slurm_model_jobs_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">models_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">suffix_repo</span> <span class="o">=</span> <span class="s1">&#39;_repo&#39;</span>
            <span class="n">suffix_job</span> <span class="o">=</span> <span class="s1">&#39;_job&#39;</span>
            <span class="n">job_param_pattern</span> <span class="o">=</span> <span class="s2">&quot;(.+)_job_(.+)&quot;</span>
            <span class="n">job_param_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">job_param_pattern</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix_repo</span><span class="p">):</span>
                <span class="n">slurm_model_repos</span><span class="p">[</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix_repo</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix_job</span><span class="p">):</span>
                <span class="n">slurm_model_jobs</span><span class="p">[</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix_job</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">slurm_model_jobs_params</span><span class="p">[</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix_job</span><span class="p">)]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">job_param_match</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Match: </span><span class="si">{slurm_model_jobs_params}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">slurm_model_jobs_params</span><span class="p">[</span><span class="n">job_param_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; --{job_param_match.group(2)}=</span><span class="si">{v}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: </span><span class="si">{slurm_model_jobs_params}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slurm_model_paths</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">slurm_script_path</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;SLURM&quot;</span><span class="p">,</span> <span class="s2">&quot;slurm_script_path&quot;</span><span class="p">,</span>
            <span class="n">fallback</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_SLURM_GIT_SCRIPT_PATH</span><span class="p">)</span>
        <span class="n">slurm_script_repo</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;SLURM&quot;</span><span class="p">,</span> <span class="s2">&quot;slurm_script_repo&quot;</span><span class="p">,</span>
            <span class="n">fallback</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        
        <span class="c1"># Parse converters, if available</span>
        <span class="c1"># Should be key=value where key is a name and value a docker image</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">converter_items</span> <span class="o">=</span> <span class="n">configs</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s2">&quot;CONVERTERS&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">converter_items</span><span class="p">:</span>
                <span class="n">converter_images</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">converter_items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">converter_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Section exists but is empty</span>
        <span class="k">except</span> <span class="n">configparser</span><span class="o">.</span><span class="n">NoSectionError</span><span class="p">:</span>
            <span class="n">converter_images</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Section does not exist       </span>
        
        <span class="c1"># Create the SlurmClient object with the parameters read from</span>
        <span class="c1"># the config file</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                   <span class="n">inline_ssh_env</span><span class="o">=</span><span class="n">inline_ssh_env</span><span class="p">,</span>
                   <span class="n">slurm_data_path</span><span class="o">=</span><span class="n">slurm_data_path</span><span class="p">,</span>
                   <span class="n">slurm_images_path</span><span class="o">=</span><span class="n">slurm_images_path</span><span class="p">,</span>
                   <span class="n">slurm_converters_path</span><span class="o">=</span><span class="n">slurm_converters_path</span><span class="p">,</span>
                   <span class="n">slurm_model_paths</span><span class="o">=</span><span class="n">slurm_model_paths</span><span class="p">,</span>
                   <span class="n">slurm_model_repos</span><span class="o">=</span><span class="n">slurm_model_repos</span><span class="p">,</span>
                   <span class="n">slurm_model_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">converter_images</span><span class="o">=</span><span class="n">converter_images</span><span class="p">,</span>
                   <span class="n">slurm_model_jobs</span><span class="o">=</span><span class="n">slurm_model_jobs</span><span class="p">,</span>
                   <span class="n">slurm_model_jobs_params</span><span class="o">=</span><span class="n">slurm_model_jobs_params</span><span class="p">,</span>
                   <span class="n">slurm_script_path</span><span class="o">=</span><span class="n">slurm_script_path</span><span class="p">,</span>
                   <span class="n">slurm_script_repo</span><span class="o">=</span><span class="n">slurm_script_repo</span><span class="p">,</span>
                   <span class="n">init_slurm</span><span class="o">=</span><span class="n">init_slurm</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.cleanup_tmp_files"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.cleanup_tmp_files">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_tmp_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">slurm_job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">data_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup zip and unzipped files/folders associated with a Slurm job.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurm_job_id (str): The job ID of the Slurm script.</span>
<span class="sd">            filename (str): The zip filename on Slurm.</span>
<span class="sd">            data_location (str, optional): The location of data files on Slurm.</span>
<span class="sd">                If not provided, it will be extracted from the log file.</span>
<span class="sd">            logfile (str, optional): The log file of the Slurm job. </span>
<span class="sd">                If not provided, a default log file will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the cleanup operation.</span>

<span class="sd">        Note:</span>
<span class="sd">            The cleanup process involves removing the specified zip file, </span>
<span class="sd">            the log file, and associated data files and folders.</span>

<span class="sd">        Example:</span>
<span class="sd">            # Cleanup temporary files for a Slurm job</span>
<span class="sd">            client.cleanup_tmp_files(&quot;12345&quot;, &quot;output.zip&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># zip</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">rmzip</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rm </span><span class="se">\&quot;</span><span class="si">{filename}</span><span class="se">\&quot;</span><span class="s2">.*&quot;</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmzip</span><span class="p">)</span>
        <span class="c1"># log</span>
        <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOGFILE</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_job_id</span><span class="o">=</span><span class="n">slurm_job_id</span><span class="p">)</span>
        <span class="n">rmlog</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rm </span><span class="se">\&quot;</span><span class="si">{logfile}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmlog</span><span class="p">)</span>
        <span class="c1"># converter logs</span>
        <span class="n">clog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONVERTER_LOGFILE</span>
        <span class="n">clog</span> <span class="o">=</span> <span class="n">clog</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_job_id</span><span class="o">=</span><span class="n">slurm_job_id</span><span class="p">)</span>
        <span class="n">rmclog</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{clog}</span><span class="s2">&quot;</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmclog</span><span class="p">)</span>
        
        <span class="c1"># data</span>
        <span class="k">if</span> <span class="n">data_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_data_location_from_log</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">data_location</span><span class="p">:</span>
            <span class="n">rmdata</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="se">\&quot;</span><span class="si">{data_location}</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="si">{data_location}</span><span class="se">\&quot;</span><span class="s2">.*&quot;</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmdata</span><span class="p">)</span>
            
            <span class="c1"># convert config file</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;config_{os.path.basename(data_location)}.txt&quot;</span>
            <span class="n">rmconfig</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;rm </span><span class="se">\&quot;</span><span class="si">{config_file}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmconfig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract data location from log </span><span class="si">{logfile}</span><span class="s2">. Skipping cleanup.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># do as much as possible, not conditional removal</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; ; &#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnexpectedExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span> <span class="ow">or</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SlurmClient.validate"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate_slurm_setup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the connection to the Slurm cluster by running</span>
<span class="sd">        a simple command.</span>

<span class="sd">        Args:</span>
<span class="sd">            validate_slurm_setup (bool): Whether to also check</span>
<span class="sd">                and fix the Slurm setup (folders, images, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool:</span>
<span class="sd">                True if the validation is successful,</span>
<span class="sd">                False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;echo &quot; &quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ok</span>
        <span class="k">if</span> <span class="n">connected</span> <span class="ow">and</span> <span class="n">validate_slurm_setup</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup_slurm</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">SSHException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">connected</span></div>

<div class="viewcode-block" id="SlurmClient.get_recent_log_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_recent_log_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_recent_log_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the command to retrieve the recent log entries from a</span>
<span class="sd">        specified log file.</span>

<span class="sd">        Args:</span>
<span class="sd">            log_file (str): The path to the log file.</span>
<span class="sd">            n (int, optional): The number of recent log entries to retrieve.</span>
<span class="sd">                Defaults to 10.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The command to retrieve the recent log entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TAIL_LOG_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.get_active_job_progress"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_active_job_progress">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_job_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">slurm_job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\d+%&quot;</span><span class="p">,</span>
                                <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the progress of an active Slurm job from its logfiles.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurm_job_id (str): The ID of the Slurm job.</span>
<span class="sd">            pattern (str): The pattern to match in the job log to extract</span>
<span class="sd">                the progress (default: r&quot;\d+%&quot;).</span>

<span class="sd">            env (Dict[str, str], optional): Optional environment variables </span>
<span class="sd">                to set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The progress of the Slurm job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmdlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_log_command</span><span class="p">(</span>
            <span class="n">log_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOGFILE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_job_id</span><span class="o">=</span><span class="n">slurm_job_id</span><span class="p">))</span>
        <span class="n">cmdlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue with run command: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Match the specified pattern in the result&#39;s stdout</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latest_progress</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
                <span class="n">pattern</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue with extracting progress: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Progress: </span><span class="si">{latest_progress}</span><span class="se">\n</span><span class="s2">&quot;</span></div>

<div class="viewcode-block" id="SlurmClient.run_commands"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.run_commands">[docs]</a>    <span class="k">def</span> <span class="nf">run_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                     <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &amp;&amp; &#39;</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a list of shell commands consecutively on the Slurm cluster,</span>
<span class="sd">        ensuring the success of each before proceeding to the next.</span>

<span class="sd">        The environment variables can be set using the `env` argument.</span>
<span class="sd">        These commands retain the same session (environment variables</span>
<span class="sd">        etc.), unlike running them separately.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmdlist (List[str]): A list of shell commands to run on Slurm.</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables to</span>
<span class="sd">                set when running the command. Defaults to None.</span>
<span class="sd">            sep (str, optional): The separator used to concatenate the </span>
<span class="sd">                commands. Defaults to &#39; &amp;&amp; &#39;.</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the last command in the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Running commands, with env </span><span class="si">{env}</span><span class="s2"> and sep </span><span class="si">{sep}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                and </span><span class="si">{kwargs}</span><span class="s2">: </span><span class="si">{cmd}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># out_stream=out_stream,</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Watch out for UnicodeEncodeError when you str() this.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{result.stdout}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unicode error: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: ONLY stdout RECODE NEEDED?? or also error?</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SlurmClient.str_to_class"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.str_to_class">[docs]</a>    <span class="k">def</span> <span class="nf">str_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a class instance from a string reference.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_name (str): The name of the module.</span>
<span class="sd">            class_name (str): The name of the class.</span>
<span class="sd">            *args: Additional positional arguments for the class constructor.</span>
<span class="sd">            **kwargs: Additional keyword arguments for the class constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: An instance of the specified class, or None if the class or</span>
<span class="sd">                module does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module_</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Class does not exist&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Module does not exist&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_</span> <span class="ow">or</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SlurmClient.run_commands_split_out"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.run_commands_split_out">[docs]</a>    <span class="k">def</span> <span class="nf">run_commands_split_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">cmdlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                               <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run a list of shell commands consecutively and split the output</span>
<span class="sd">        of each command.</span>

<span class="sd">        Each command in the list is executed with a separator in between</span>
<span class="sd">        that is unique and can be used to split</span>
<span class="sd">        the output of each command later. The separator used is specified</span>
<span class="sd">        by the `_OUT_SEP` attribute of the</span>
<span class="sd">        SlurmClient instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmdlist (List[str]): A list of shell commands to run.</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables </span>
<span class="sd">                to set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]:</span>
<span class="sd">                A list of strings, where each string corresponds to</span>
<span class="sd">                the output of a single command in `cmdlist` split</span>
<span class="sd">                by the separator `_OUT_SEP`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If any of the commands fail to execute successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">cmdlist</span><span class="o">=</span><span class="n">cmdlist</span><span class="p">,</span>
                                       <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
                                       <span class="n">sep</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot; ; echo </span><span class="si">{self._OUT_SEP}</span><span class="s2"> ; &quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnexpectedExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">result</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
            <span class="n">split_responses</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_OUT_SEP</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">split_responses</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the result is not ok, log the error and raise an SSHException</span>
            <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Result is not ok: </span><span class="si">{result}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.list_active_jobs"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.list_active_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">list_active_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of active jobs from SLURM.</span>

<span class="sd">        Args:</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables to </span>
<span class="sd">                set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list of job IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cmd = self._ACTIVE_JOBS_CMD</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_info_command</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="s2">&quot;now&quot;</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieving list of active jobs from Slurm&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">job_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">job_list</span></div>

<div class="viewcode-block" id="SlurmClient.list_completed_jobs"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.list_completed_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">list_completed_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of completed jobs from SLURM.</span>

<span class="sd">        Args:</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables to</span>
<span class="sd">                set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list of job IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_info_command</span><span class="p">(</span><span class="n">states</span><span class="o">=</span><span class="s2">&quot;cd&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieving a list of completed jobs from Slurm&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
        <span class="n">job_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">job_list</span></div>

<div class="viewcode-block" id="SlurmClient.list_all_jobs"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.list_all_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">list_all_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of all jobs from SLURM.</span>

<span class="sd">        Args:</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables </span>
<span class="sd">                to set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: A list of job IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_info_command</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieving a list of all jobs from Slurm&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">job_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">job_list</span></div>

<div class="viewcode-block" id="SlurmClient.get_jobs_info_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_jobs_info_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs_info_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2023-01-01&quot;</span><span class="p">,</span>
                              <span class="n">end_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;now&quot;</span><span class="p">,</span>
                              <span class="n">columns</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;JobId&quot;</span><span class="p">,</span>
                              <span class="n">states</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;r,cd,f,to,rs,dl,nf&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the Slurm command to retrieve information about old jobs.</span>

<span class="sd">        The command will be formatted with the specified start time, which is</span>
<span class="sd">        expected to be in the ISO format &quot;YYYY-MM-DD&quot;.</span>
<span class="sd">        The command will use the &quot;sacct&quot; tool to query the</span>
<span class="sd">        Slurm accounting database for jobs that started on or after the</span>
<span class="sd">        specified start time, and will output only the job IDs (-o JobId)</span>
<span class="sd">        without header or trailer lines (-n -X).</span>

<span class="sd">        Args:</span>
<span class="sd">            start_time (str): The start time from which to retrieve job</span>
<span class="sd">                information. Defaults to &quot;2023-01-01&quot;.</span>
<span class="sd">            end_time (str): The end time until which to retrieve job</span>
<span class="sd">                information. Defaults to &quot;now&quot;.</span>
<span class="sd">            columns (str): The columns to retrieve from the job information.</span>
<span class="sd">                Defaults to &quot;JobId&quot;. It is comma separated, e.g. &quot;JobId,State&quot;.</span>
<span class="sd">            states (str): The job states to include in the query.</span>
<span class="sd">                Defaults to &quot;r,cd,f,to,rs,dl,nf&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str:</span>
<span class="sd">                A string representing the Slurm command to retrieve</span>
<span class="sd">                information about old jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALL_JOBS_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                                         <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
                                         <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span>
                                         <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.transfer_data"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.transfer_data">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfers a file or directory from the local machine to the remote</span>
<span class="sd">        Slurm cluster.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_path (str): The local path to the file or directory to</span>
<span class="sd">                transfer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the file transfer operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Transfering file </span><span class="si">{local_path}</span><span class="s2"> to </span><span class="si">{self.slurm_data_path}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">local_path</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_data_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.unpack_data"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.unpack_data">[docs]</a>    <span class="k">def</span> <span class="nf">unpack_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpacks a zipped file on the remote Slurm cluster.</span>

<span class="sd">        Args:</span>
<span class="sd">            zipfile (str): The name of the zipped file to be unpacked.</span>

<span class="sd">            env (Dict[str, str], optional): Optional environment variables </span>
<span class="sd">                to set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unzip_command</span><span class="p">(</span><span class="n">zipfile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unpacking </span><span class="si">{zipfile}</span><span class="s2"> on Slurm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.generate_slurm_job_for_workflow"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.generate_slurm_job_for_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">generate_slurm_job_for_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                        <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                        <span class="n">substitutes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                        <span class="n">template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;job_template.sh&quot;</span>
                                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a Slurm job script for a specific workflow.</span>

<span class="sd">        Args:</span>
<span class="sd">            workflow (str): The name of the workflow.</span>
<span class="sd">            substitutes (Dict[str, str]): A dictionary containing key-value</span>
<span class="sd">                pairs for substituting placeholders in the job template.</span>
<span class="sd">            template (str, optional): The filename of the job template.</span>
<span class="sd">                Defaults to &quot;job_template.sh&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The generated Slurm job script as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add workflow to substitutes</span>
        <span class="n">substitutes</span><span class="p">[</span><span class="s1">&#39;jobname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow</span>
        <span class="c1"># grab job template</span>
        <span class="n">template_f</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">template_f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">job_script</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">substitutes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job_script</span></div>

<div class="viewcode-block" id="SlurmClient.workflow_params_to_subs"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.workflow_params_to_subs">[docs]</a>    <span class="k">def</span> <span class="nf">workflow_params_to_subs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert workflow parameters to substitution dictionary for job script.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: A dictionary containing workflow parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, str]: A dictionary with parameter names as keys and</span>
<span class="sd">                corresponding flags with placeholders as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;cmd_flag&#39;</span><span class="p">]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">+</span> <span class="s2">&quot; $&quot;</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="n">subs</span><span class="p">[</span><span class="s1">&#39;PARAMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subs</span></div>

<div class="viewcode-block" id="SlurmClient.update_slurm_scripts"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.update_slurm_scripts">[docs]</a>    <span class="k">def</span> <span class="nf">update_slurm_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">generate_jobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the local copy of the Slurm job submission scripts.</span>

<span class="sd">        This function pulls the latest version of the scripts from the Git</span>
<span class="sd">        repository and copies them to the slurm_script_path directory.</span>
<span class="sd">        Alternatively, it can generate scripts from a template. This is the</span>
<span class="sd">        default behavior if no Git repo is provided or can be forced via the</span>
<span class="sd">        `generate_jobs` parameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            generate_jobs (bool): Whether to generate new slurm job scripts</span>
<span class="sd">                INSTEAD (of pulling from git). Defaults to False, except</span>
<span class="sd">                if no slurm_script_repo is configured.</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables </span>
<span class="sd">                to set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_repo</span><span class="p">:</span>
            <span class="n">generate_jobs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">generate_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating Slurm job scripts&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wf</span><span class="p">,</span> <span class="n">job_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># generate job script</span>
                <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_workflow_parameters</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
                <span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_params_to_subs</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">job_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_slurm_job_for_workflow</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">subs</span><span class="p">)</span>
                <span class="c1"># ensure all dirs exist remotely</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_script_path</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">job_path</span>
                <span class="n">job_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mkdir -p </span><span class="se">\&quot;</span><span class="si">{job_dir}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># copy to remote file</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">job_script</span><span class="p">),</span>
                                  <span class="n">remote</span><span class="o">=</span><span class="n">full_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_update_slurm_scripts_command</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating Slurm job scripts on Slurm&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SlurmClient.run_workflow"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.run_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">run_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">workflow_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">input_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Result</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a specified workflow on Slurm using the given parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            workflow_name (str): Name of the workflow to execute.</span>
<span class="sd">            workflow_version (str): Version of the workflow (image version </span>
<span class="sd">                on Slurm).</span>
<span class="sd">            input_data (str): Name of the input data folder containing input</span>
<span class="sd">                image files.</span>
<span class="sd">            email (str, optional): Email address for Slurm job notifications.</span>
<span class="sd">            time (str, optional): Time limit for the Slurm job in the </span>
<span class="sd">                format HH:MM:SS.</span>
<span class="sd">            **kwargs: Additional keyword arguments for the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Result, int]:</span>
<span class="sd">                A tuple containing the result of starting the workflow job and</span>
<span class="sd">                the Slurm job ID, or -1 if the job ID could not be extracted.</span>

<span class="sd">        Note:</span>
<span class="sd">            The Slurm job ID is extracted from the result of the </span>
<span class="sd">            `run_commands` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sbatch_cmd</span><span class="p">,</span> <span class="n">sbatch_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_workflow_command</span><span class="p">(</span>
            <span class="n">workflow_name</span><span class="p">,</span> <span class="n">workflow_version</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running </span><span class="si">{workflow_name}</span><span class="s2"> job on </span><span class="si">{input_data}</span><span class="s2"> on Slurm:</span><span class="se">\</span>
<span class="s2">            </span><span class="si">{sbatch_cmd}</span><span class="s2"> w/ </span><span class="si">{sbatch_env}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running </span><span class="si">{workflow_name}</span><span class="s2"> job on </span><span class="si">{input_data}</span><span class="s2"> on Slurm&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">sbatch_cmd</span><span class="p">],</span> <span class="n">sbatch_env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_job_id</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.run_workflow_job"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.run_workflow_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_workflow_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">workflow_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">input_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SlurmJob</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a specified workflow on Slurm using the given parameters and return a SlurmJob instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            workflow_name (str): Name of the workflow to execute.</span>
<span class="sd">            workflow_version (str): Version of the workflow (image version on Slurm).</span>
<span class="sd">            input_data (str): Name of the input data folder containing input image files.</span>
<span class="sd">            email (str, optional): Email address for Slurm job notifications.</span>
<span class="sd">            time (str, optional): Time limit for the Slurm job in the format HH:MM:SS.</span>
<span class="sd">            **kwargs: Additional keyword arguments for the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SlurmJob: A SlurmJob instance representing the started workflow job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_workflow</span><span class="p">(</span>
            <span class="n">workflow_name</span><span class="p">,</span> <span class="n">workflow_version</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SlurmJob</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.run_conversion_workflow_job"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.run_conversion_workflow_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_conversion_workflow_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">source_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;zarr&#39;</span><span class="p">,</span>
                                    <span class="n">target_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tiff&#39;</span>
                                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Result</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the data conversion workflow on Slurm using the given data folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_name (str): The name of the data folder containing source format files.</span>
<span class="sd">            source_format (str): Source data format for conversion (default is &#39;zarr&#39;).</span>
<span class="sd">            target_format (str): Target data format after conversion (default is &#39;tiff&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Result, int]:</span>
<span class="sd">                A tuple containing the result of starting the conversion job and</span>
<span class="sd">                the Slurm job ID, or -1 if the job ID could not be extracted.</span>

<span class="sd">        Warning:</span>
<span class="sd">            The default implementation only supports conversion from &#39;zarr&#39; to &#39;tiff&#39;.</span>
<span class="sd">            If using other source or target formats, users must implement and configure</span>
<span class="sd">            additional converters themselves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate a unique config file name</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;config_</span><span class="si">{folder_name}</span><span class="s2">.txt&quot;</span>

        <span class="c1"># Construct all commands to run consecutively</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{folder_name}</span><span class="s2">&quot;</span>
        <span class="n">conversion_cmd</span><span class="p">,</span> <span class="n">sbatch_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conversion_command</span><span class="p">(</span>
            <span class="n">data_path</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">source_format</span><span class="p">,</span> <span class="n">target_format</span><span class="p">)</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;find </span><span class="se">\&quot;</span><span class="si">{data_path}</span><span class="s2">/data/in</span><span class="se">\&quot;</span><span class="s2"> -name </span><span class="se">\&quot;</span><span class="s2">*.</span><span class="si">{source_format}</span><span class="se">\&quot;</span><span class="s2"> | awk &#39;{{print NR, $0}}&#39; &gt; </span><span class="se">\&quot;</span><span class="si">{config_file}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;N=$(wc -l &lt; </span><span class="se">\&quot;</span><span class="si">{config_file}</span><span class="se">\&quot;</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;echo </span><span class="se">\&quot;</span><span class="s2">Number of .</span><span class="si">{source_format}</span><span class="s2"> files: $N</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">conversion_cmd</span>
        <span class="p">]</span>

        <span class="c1"># Run all commands consecutively</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">sbatch_env</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SlurmJob</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_job_id</span><span class="p">(</span><span class="n">res</span><span class="p">))</span></div>

<div class="viewcode-block" id="SlurmClient.extract_job_id"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.extract_job_id">[docs]</a>    <span class="k">def</span> <span class="nf">extract_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Result</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the Slurm job ID from the result of a command.</span>

<span class="sd">        Args:</span>
<span class="sd">            result (Result): The result of a command execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int:</span>
<span class="sd">                The Slurm job ID extracted from the result,</span>
<span class="sd">                or -1 if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slurm_job_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                            <span class="s2">&quot;Submitted batch job&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slurm_job_id</span></div>

<div class="viewcode-block" id="SlurmClient.get_update_slurm_scripts_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_update_slurm_scripts_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_update_slurm_scripts_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate the command to update the Git repository containing</span>
<span class="sd">        the Slurm scripts, if necessary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str:</span>
<span class="sd">                A string containing the Git command</span>
<span class="sd">                to update the Slurm scripts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">update_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;git -C </span><span class="se">\&quot;</span><span class="si">{self.slurm_script_path}</span><span class="se">\&quot;</span><span class="s2"> pull&quot;</span>
        <span class="k">return</span> <span class="n">update_cmd</span></div>

<div class="viewcode-block" id="SlurmClient.check_job_status"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.check_job_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">slurm_job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                         <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Result</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of Slurm jobs with the given job IDs.</span>

<span class="sd">        Note: This doesn&#39;t return job arrays individually.</span>
<span class="sd">        It takes the last value returned for those sub ids </span>
<span class="sd">        (generally the one still PENDING).</span>

<span class="sd">        Args:</span>
<span class="sd">            slurm_job_ids (List[int]): The job IDs of the Slurm jobs to check.</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables to</span>
<span class="sd">                set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Dict[int, str], Result]:</span>
<span class="sd">                A tuple containing the status per input ID and the result of </span>
<span class="sd">                the command execution.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If the command execution fails or no response is</span>
<span class="sd">                received after multiple retries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_status_command</span><span class="p">(</span><span class="n">slurm_job_ids</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting status of </span><span class="si">{slurm_job_ids}</span><span class="s2"> on Slurm&quot;</span><span class="p">)</span>
        <span class="n">retry_status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">retry_status</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="c1"># wait for 3 seconds before checking again</span>
                    <span class="n">timesleep</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="c1"># retry</span>
                    <span class="n">retry_status</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Retry </span><span class="si">{retry_status}</span><span class="s2"> getting status </span><span class="se">\</span>
<span class="s2">                            of </span><span class="si">{slurm_job_ids}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="n">job_status_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="p">}</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job statuses: </span><span class="si">{job_status_dict}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># OK, we have to fix a stupid sacct functionality:</span>
                    <span class="c1"># Problem:</span>
                    <span class="c1"># When you query for a job-id, turns out that it queries</span>
                    <span class="c1"># for this &#39;JobIdRaw&#39;. And JobIdRaw for arrays is a </span>
                    <span class="c1"># ridiculous sum, e.g. &#39;JobId&#39; 11_2 gets assigned </span>
                    <span class="c1"># &#39;JobIdRaw&#39; 13 (= 11+2)!</span>
                    <span class="c1"># Until you submit 2 more jobs and actual &#39;JobId&#39; 13 comes</span>
                    <span class="c1"># along, from then on you get that status returned...</span>
                    <span class="c1"># For us, this creates a race condition, where we get th</span>
                    <span class="c1"># e wrong data back. We expect &#39;JobId&#39; 13, but its not </span>
                    <span class="c1"># there yet for some reason, so we get some result </span>
                    <span class="c1"># from &#39;11_2&#39; back instead. </span>
                    <span class="c1"># And this causes a key_error later on, cause we expect</span>
                    <span class="c1"># &#39;13&#39; since we queried for that one.</span>
                    
                    <span class="c1"># Current workaround: artificially add &#39;13&#39; to our results.</span>
                    <span class="c1"># And remove the fake one(s).</span>
                    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">slurm_job_ids</span><span class="p">:</span>
                        <span class="c1"># Check if the job ID is not already in the job_status_dict</span>
                        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_status_dict</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing job </span><span class="si">{job_id}</span><span class="s2"> in our </span><span class="se">\</span>
<span class="s2">                                results! Adding it artificially.&quot;</span><span class="p">)</span>
                            <span class="c1"># Add the job ID with a default status of &#39;PENDING&#39;</span>
                            <span class="n">result_dict</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PENDING&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Copy those values that we want the keys from</span>
                            <span class="n">result_dict</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_status_dict</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
                    
                    <span class="k">return</span> <span class="n">result_dict</span><span class="p">,</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Result is not ok: </span><span class="si">{result}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: Retried </span><span class="si">{retry_status}</span><span class="s2"> times to get </span><span class="se">\</span>
<span class="s2">                status of </span><span class="si">{slurm_job_ids}</span><span class="s2">, but no response.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.get_job_status_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_job_status_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_status_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slurm_job_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Slurm command to get the status of jobs with the given</span>
<span class="sd">        job IDs.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurm_job_ids (List[int]): The job IDs of the jobs to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: </span>
<span class="sd">                The Slurm command to get the status of the jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># concat multiple jobs if needed</span>
        <span class="n">slurm_job_id</span> <span class="o">=</span> <span class="s2">&quot; -j &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">slurm_job_ids</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_JOB_STATUS_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_job_id</span><span class="o">=</span><span class="n">slurm_job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.extract_data_location_from_log"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.extract_data_location_from_log">[docs]</a>    <span class="k">def</span> <span class="nf">extract_data_location_from_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slurm_job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                       <span class="n">logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read SLURM job logfile to find location of the data.</span>

<span class="sd">        One of the parameters is required, either id or file.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurm_job_id (str): Id of the slurm job</span>
<span class="sd">            logfile (str): Path to the logfile</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Data location according to the log</span>

<span class="sd">        Raises:</span>
<span class="sd">            SSHException: If there is an issue with the command execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">slurm_job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOGFILE</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_job_id</span><span class="o">=</span><span class="n">slurm_job_id</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOGFILE_DATA_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_file</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">cmd</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHException</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.get_workflow_parameters"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_workflow_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_workflow_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the parameters of a workflow.</span>

<span class="sd">        Args:</span>
<span class="sd">            workflow (str): The workflow for which to retrieve the parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Dict[str, Any]]:</span>
<span class="sd">                A dictionary containing the workflow parameters.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an error occurs while retrieving the workflow</span>
<span class="sd">                parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_descriptor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pull_descriptor_from_github</span><span class="p">(</span><span class="n">workflow</span><span class="p">)</span>
        <span class="c1"># convert to omero types</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">json_descriptor</span><span class="p">)</span>
        <span class="n">workflow_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">json_descriptor</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
            <span class="c1"># filter cytomine parameters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cytomine&#39;</span><span class="p">):</span>
                <span class="n">workflow_params</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">workflow_params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">workflow_params</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;default-value&#39;</span><span class="p">]</span>
                <span class="n">workflow_params</span><span class="p">[</span><span class="s1">&#39;cytype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="n">workflow_params</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span>
                <span class="n">cmd_flag</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;command-line-flag&#39;</span><span class="p">]</span>
                <span class="n">cmd_flag</span> <span class="o">=</span> <span class="n">cmd_flag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@id&quot;</span><span class="p">,</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">workflow_params</span><span class="p">[</span><span class="s1">&#39;cmd_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_flag</span>
                <span class="n">workflow_params</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
                <span class="n">workflow_dict</span><span class="p">[</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">workflow_params</span>
        <span class="k">return</span> <span class="n">workflow_dict</span></div>

<div class="viewcode-block" id="SlurmClient.convert_cytype_to_omtype"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.convert_cytype_to_omtype">[docs]</a>    <span class="k">def</span> <span class="nf">convert_cytype_to_omtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">cytype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a Cytomine type to an OMERO type and instantiates it</span>
<span class="sd">        with args/kwargs.</span>

<span class="sd">        Note that Cytomine has a Python Client, and some conversion methods</span>
<span class="sd">        to python types, but nothing particularly worth depending on that</span>
<span class="sd">        library for yet. Might be useful in the future perhaps.</span>
<span class="sd">        (e.g. https://github.com/Cytomine-ULiege/Cytomine-python-client/</span>
<span class="sd">        blob/master/cytomine/cytomine_job.py)</span>

<span class="sd">        Args:</span>
<span class="sd">            cytype (str): The Cytomine type to convert.</span>
<span class="sd">            _default: The default value. Required to distinguish between float</span>
<span class="sd">                and int.</span>
<span class="sd">            *args: Additional positional arguments.</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any:</span>
<span class="sd">                The converted OMERO type class instance</span>
<span class="sd">                or None if errors occured.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO make Enum ?</span>
        <span class="k">if</span> <span class="n">cytype</span> <span class="o">==</span> <span class="s1">&#39;Number&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_default</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="c1"># float instead</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_to_class</span><span class="p">(</span><span class="s2">&quot;omero.scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;Float&quot;</span><span class="p">,</span>
                                         <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_to_class</span><span class="p">(</span><span class="s2">&quot;omero.scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;Int&quot;</span><span class="p">,</span>
                                         <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cytype</span> <span class="o">==</span> <span class="s1">&#39;Boolean&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_to_class</span><span class="p">(</span><span class="s2">&quot;omero.scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;Bool&quot;</span><span class="p">,</span>
                                     <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cytype</span> <span class="o">==</span> <span class="s1">&#39;String&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str_to_class</span><span class="p">(</span><span class="s2">&quot;omero.scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;String&quot;</span><span class="p">,</span>
                                     <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.extract_parts_from_url"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.extract_parts_from_url">[docs]</a>    <span class="k">def</span> <span class="nf">extract_parts_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the repository and branch information from the input URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_url (str): The input GitHub URL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[str], str]:</span>
<span class="sd">                The list of url parts and the branch/version.</span>
<span class="sd">                If no branch is found, it will return &quot;master&quot;</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the input URL is not a valid GitHub URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url_parts</span> <span class="o">=</span> <span class="n">input_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">url_parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">url_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;github.com&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid GitHub URL&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;tree&quot;</span> <span class="ow">in</span> <span class="n">url_parts</span><span class="p">:</span>
            <span class="c1"># Case: URL contains a branch</span>
            <span class="n">branch_index</span> <span class="o">=</span> <span class="n">url_parts</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;tree&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">url_parts</span><span class="p">[</span><span class="n">branch_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Case: URL does not specify a branch</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="s2">&quot;master&quot;</span>

        <span class="k">return</span> <span class="n">url_parts</span><span class="p">,</span> <span class="n">branch</span></div>
       
<div class="viewcode-block" id="SlurmClient.parse_docker_image_version"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.parse_docker_image_version">[docs]</a>    <span class="k">def</span> <span class="nf">parse_docker_image_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the Docker image string to extract the image name and version tag.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (str): The Docker image string in the format &#39;image_name:version&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing:</span>
<span class="sd">                - version (str or None): The version tag if present, otherwise None.</span>
<span class="sd">                - image_name (str): The image name if matched, otherwise the original image string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Regular expression to match image:tag format</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^([^:]+)(?::([^:]+))?$&#39;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">image_name</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">version</span> <span class="k">if</span> <span class="n">version</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">image_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">image</span></div>
    
<div class="viewcode-block" id="SlurmClient.convert_url"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.convert_url">[docs]</a>    <span class="k">def</span> <span class="nf">convert_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the input GitHub URL to an output URL that retrieves</span>
<span class="sd">        the &#39;descriptor.json&#39; file in raw format.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_url (str): The input GitHub URL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The output URL to the &#39;descriptor.json&#39; file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the input URL is not a valid GitHub URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url_parts</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_parts_from_url</span><span class="p">(</span><span class="n">input_url</span><span class="p">)</span>

        <span class="c1"># Construct the output URL by combining the extracted information</span>
        <span class="c1"># with the desired file path</span>
        <span class="n">output_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://github.com/</span><span class="si">{url_parts[3]}</span><span class="s2">/</span><span class="si">{url_parts[4]}</span><span class="s2">/raw/</span><span class="si">{branch}</span><span class="s2">/descriptor.json&quot;</span>

        <span class="k">return</span> <span class="n">output_url</span></div>

<div class="viewcode-block" id="SlurmClient.pull_descriptor_from_github"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.pull_descriptor_from_github">[docs]</a>    <span class="k">def</span> <span class="nf">pull_descriptor_from_github</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull the workflow descriptor from GitHub.</span>

<span class="sd">        Args:</span>
<span class="sd">            workflow (str): The workflow for which to pull the descriptor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: The JSON descriptor.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an error occurs while pulling the descriptor file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">git_repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_repos</span><span class="p">[</span><span class="n">workflow</span><span class="p">]</span>
        <span class="c1"># convert git repo to json file</span>
        <span class="n">raw_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_url</span><span class="p">(</span><span class="n">git_repo</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pull workflow: </span><span class="si">{workflow}</span><span class="s2">: </span><span class="si">{git_repo}</span><span class="s2"> &gt;&gt; </span><span class="si">{raw_url}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># pull workflow params</span>
        <span class="n">github_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_github_session</span><span class="p">()</span>
        <span class="n">ghfile</span> <span class="o">=</span> <span class="n">github_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">raw_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ghfile</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cached? </span><span class="si">{ghfile.from_cache}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">json_descriptor</span> <span class="o">=</span> <span class="n">ghfile</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Error while pulling descriptor file for workflow </span><span class="si">{workflow}</span><span class="s1">,</span><span class="se">\</span>
<span class="s1">                    from </span><span class="si">{raw_url}</span><span class="s1">: </span><span class="si">{ghfile.__dict__}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_descriptor</span></div>

<div class="viewcode-block" id="SlurmClient.get_or_create_github_session"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_or_create_github_session">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_create_github_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note, using requests_cache 1.1.1, conditional queries are default:</span>
        <span class="c1"># The cached response will still be used until the remote content actually changes</span>
        <span class="c1"># Even if the &#39;expire_after&#39; is triggered. This is built into GitHub, which returns</span>
        <span class="c1"># a Etag in the header that only changes when the content (e.g. the descriptor) changes.</span>
        <span class="c1"># If you provide this Etag when querying, you will get a 304 (&#39;no change&#39;) and it will</span>
        <span class="c1"># NOT count towards your Github limits. And requests_cache does that for us now.</span>
        <span class="c1"># Not available in Python3.6 though.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">requests_cache</span><span class="o">.</span><span class="n">CachedSession</span><span class="p">(</span><span class="s1">&#39;github_cache&#39;</span><span class="p">,</span>
                                         <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span>
                                         <span class="n">expire_after</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">cache_control</span><span class="o">=</span><span class="kc">True</span>
                                         <span class="p">)</span>
        <span class="c1"># Might have bigger issues, this is related to rate limits on GitHub</span>
        <span class="c1"># https://docs.github.com/en/rest/using-the-rest-api/rate-limits-for-the-rest-api</span>
        <span class="c1"># If it stays a problem, we have to add an option to add a GH key to the config</span>
        <span class="c1"># E.g. see https://github.com/requests-cache/requests-cache/blob/53134ef0e99d713fed62515dfb7bcfaac5f63f9d/examples/pygithub.py</span>
        <span class="c1"># Here you could have an ACCESS_TOKEN.</span>
        <span class="c1"># An ACCESS_TOKEN could improve api limits to 5000/h (from 60/h).</span>
        <span class="n">retry_strategy</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>               <span class="c1"># Maximum number of retries</span>
            <span class="c1"># Exponential backoff factor (delay between retries)</span>
            <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="c1"># Retry on these HTTP status codes</span>
            <span class="n">status_forcelist</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="mi">429</span><span class="p">],</span>
            <span class="n">allowed_methods</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>  <span class="c1"># Only retry for GET requests</span>
        <span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;https://github.com/&#39;</span><span class="p">,</span> <span class="n">HTTPAdapter</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="n">retry_strategy</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;http://github.com/&#39;</span><span class="p">,</span> <span class="n">HTTPAdapter</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="n">retry_strategy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="SlurmClient.get_workflow_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_workflow_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_workflow_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">workflow_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">input_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the Slurm workflow command and environment variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            workflow (str): The name of the workflow.</span>
<span class="sd">            workflow_version (str): The version of the workflow.</span>
<span class="sd">            input_data (str): The name of the input data folder containing</span>
<span class="sd">                the input image files.</span>
<span class="sd">            email (str, optional): The email address for job notifications.</span>
<span class="sd">                Defaults to None, which defaults to what is in the job script.</span>
<span class="sd">            time (str, optional): The time limit for the job in the </span>
<span class="sd">                format HH:MM:SS. Defaults to None, which defaults to what </span>
<span class="sd">                is in the job script.</span>
<span class="sd">            **kwargs: Additional keyword arguments for the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, Dict]:</span>
<span class="sd">                A tuple containing the Slurm workflow command and</span>
<span class="sd">                the environment variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="p">[</span><span class="n">workflow</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">job_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_jobs</span><span class="p">[</span><span class="n">workflow</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">job_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_jobs_params</span><span class="p">[</span><span class="n">workflow</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="c1"># grab only the image name, not the group/creator</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_images</span><span class="p">[</span><span class="n">workflow</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">sbatch_env</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;DATA_PATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{input_data}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IMAGE_PATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_images_path}</span><span class="s2">/</span><span class="si">{model_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IMAGE_VERSION&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{workflow_version}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SINGULARITY_IMAGE&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{image}</span><span class="s2">_</span><span class="si">{workflow_version}</span><span class="s2">.sif</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SCRIPT_PATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_script_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="p">}</span>
        <span class="n">workflow_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_params_to_envvars</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">sbatch_env</span><span class="p">,</span> <span class="o">**</span><span class="n">workflow_env</span><span class="p">}</span>

        <span class="n">email_param</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">email</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; --mail-user=</span><span class="si">{email}</span><span class="s2">&quot;</span>
        <span class="n">time_param</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; --time=</span><span class="si">{time}</span><span class="s2">&quot;</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_param</span><span class="p">)</span>
        <span class="n">job_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email_param</span><span class="p">)</span>
        <span class="n">job_param</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_params</span><span class="p">)</span>
        <span class="n">sbatch_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sbatch</span><span class="si">{job_param}</span><span class="s2"> --output=omero-%j.log </span><span class="se">\</span>
<span class="s2">            </span><span class="se">\&quot;</span><span class="si">{self.slurm_script_path}</span><span class="s2">/</span><span class="si">{job_script}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">sbatch_cmd</span><span class="p">,</span> <span class="n">env</span></div>

<div class="viewcode-block" id="SlurmClient.get_conversion_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_conversion_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_conversion_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">source_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;zarr&#39;</span><span class="p">,</span>
                               <span class="n">target_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tiff&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate Slurm conversion command and environment variables for data conversion.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_path (str): Path to the data folder.</span>
<span class="sd">            config_file (str): Path to the configuration file.</span>
<span class="sd">            source_format (str): Source data format (default is &#39;zarr&#39;).</span>
<span class="sd">            target_format (str): Target data format (default is &#39;tiff&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, Dict]:</span>
<span class="sd">                A tuple containing the Slurm conversion command and</span>
<span class="sd">                the environment variables.</span>

<span class="sd">        Warning:</span>
<span class="sd">            The default implementation only supports conversion from &#39;zarr&#39; to &#39;tiff&#39;.</span>
<span class="sd">            If using other source or target formats, users must implement and configure</span>
<span class="sd">            additional converters themselves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_format</span> <span class="o">!=</span> <span class="s2">&quot;zarr&quot;</span> <span class="ow">or</span> <span class="n">target_format</span> <span class="o">!=</span> <span class="s2">&quot;tiff&quot;</span><span class="p">:</span>
            <span class="c1"># Warn about unsupported conversion; additional converters can be</span>
            <span class="c1"># added outside our knowledge.</span>
            <span class="c1"># Checking Slurm&#39;s `slurm_converters_path` is skipped for</span>
            <span class="c1"># performance reasons.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Conversion from </span><span class="si">{source_format}</span><span class="s2"> to </span><span class="si">{target_format}</span><span class="s2"> is not supported by default!&quot;</span><span class="p">)</span>

        <span class="n">chosen_converter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;convert_</span><span class="si">{source_format}</span><span class="s2">_to_</span><span class="si">{target_format}</span><span class="s2">_latest.sif&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter_images</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter_images</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{source_format}</span><span class="s2">_to_</span><span class="si">{target_format}</span><span class="s2">&quot;</span><span class="p">]</span>  
            <span class="n">version</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_docker_image_version</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span><span class="p">:</span>
                <span class="n">chosen_converter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;convert_</span><span class="si">{source_format}</span><span class="s2">_to_</span><span class="si">{target_format}</span><span class="s2">_</span><span class="si">{version}</span><span class="s2">.sif&quot;</span>    
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting with </span><span class="si">{chosen_converter}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sbatch_env</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;DATA_PATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{data_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONVERSION_PATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_converters_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONVERTER_IMAGE&quot;</span><span class="p">:</span> <span class="n">chosen_converter</span><span class="p">,</span>
            <span class="s2">&quot;SCRIPT_PATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{self.slurm_script_path}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONFIG_FILE&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{config_file}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="p">}</span>

        <span class="n">conversion_cmd</span> <span class="o">=</span> <span class="s2">&quot;sbatch --job-name=conversion --export=ALL,CONFIG_PATH=</span><span class="se">\&quot;</span><span class="s2">$PWD/$CONFIG_FILE</span><span class="se">\&quot;</span><span class="s2"> --array=1-$N </span><span class="se">\&quot;</span><span class="s2">$SCRIPT_PATH/convert_job_array.sh</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
        <span class="c1"># conversion_cmd_waiting = &quot;sbatch --job-name=conversion --export=ALL,CONFIG_PATH=\&quot;$PWD/$CONFIG_FILE\&quot; --array=1-$N --wait $SCRIPT_PATH/convert_job_array.sh&quot;</span>

        <span class="k">return</span> <span class="n">conversion_cmd</span><span class="p">,</span> <span class="n">sbatch_env</span></div>

<div class="viewcode-block" id="SlurmClient.workflow_params_to_envvars"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.workflow_params_to_envvars">[docs]</a>    <span class="k">def</span> <span class="nf">workflow_params_to_envvars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert workflow parameters to environment variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Additional keyword arguments for the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: A dictionary containing the environment variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workflow_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{value}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span>
                        <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">workflow_env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">workflow_env</span></div>

<div class="viewcode-block" id="SlurmClient.get_cellpose_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_cellpose_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_cellpose_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">input_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">cp_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">nuc_channel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">prob_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                             <span class="n">cell_diameter</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                             <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cellpose&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the command and environment dictionary to run a CellPose job</span>
<span class="sd">        on the Slurm workload manager.</span>
<span class="sd">        A specific example of using the generic &#39;get_workflow_command&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            image_version (str): The version of the Singularity image to use.</span>
<span class="sd">            input_data (str): The name of the input data folder on the shared</span>
<span class="sd">                file system.</span>
<span class="sd">            cp_model (str): The name of the CellPose model to use.</span>
<span class="sd">            nuc_channel (int): The index of the nuclear channel.</span>
<span class="sd">            prob_threshold (float): The probability threshold for</span>
<span class="sd">                nuclei detection.</span>
<span class="sd">            cell_diameter (float): The expected cell diameter in pixels.</span>
<span class="sd">            email (Optional[str]): The email address to send notifications to.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            time (Optional[str]): The maximum time for the job to run.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            use_gpu (bool): Whether to use GPU for the CellPose job.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            model (str): The name of the folder of the Docker image to use.</span>
<span class="sd">                Defaults to &quot;cellpose&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[str, dict]:</span>
<span class="sd">                A tuple containing the Slurm sbatch command</span>
<span class="sd">                and the environment dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_workflow_command</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                         <span class="n">workflow_version</span><span class="o">=</span><span class="n">image_version</span><span class="p">,</span>
                                         <span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span>
                                         <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                                         <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                         <span class="n">cp_model</span><span class="o">=</span><span class="n">cp_model</span><span class="p">,</span>
                                         <span class="n">nuc_channel</span><span class="o">=</span><span class="n">nuc_channel</span><span class="p">,</span>
                                         <span class="n">prob_threshold</span><span class="o">=</span><span class="n">prob_threshold</span><span class="p">,</span>
                                         <span class="n">cell_diameter</span><span class="o">=</span><span class="n">cell_diameter</span><span class="p">,</span>
                                         <span class="n">use_gpu</span><span class="o">=</span><span class="n">use_gpu</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.copy_zip_locally"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.copy_zip_locally">[docs]</a>    <span class="k">def</span> <span class="nf">copy_zip_locally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_tmp_storage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransferResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Copy a zip file from Slurm to the local server.</span>

<span class="sd">        Note about (Transfer)Result:</span>

<span class="sd">        Unlike similar classes such as invoke.runners.Result or</span>
<span class="sd">        fabric.runners.Result</span>
<span class="sd">        (which have a concept of “warn and return anyways on failure”)</span>
<span class="sd">        this class has no useful truthiness behavior.</span>
<span class="sd">        If a file transfer fails, some exception will be raised,</span>
<span class="sd">        either an OSError or an error from within Paramiko.</span>

<span class="sd">        Args:</span>
<span class="sd">            local_tmp_storage (String): Path to store the zip file locally.</span>
<span class="sd">            filename (String): Zip filename on Slurm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransferResult: The result of the scp attempt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying zip </span><span class="si">{filename}</span><span class="s2"> from</span><span class="se">\</span>
<span class="s2">            Slurm to </span><span class="si">{local_tmp_storage}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">remote</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.zip&quot;</span><span class="p">,</span>
            <span class="n">local</span><span class="o">=</span><span class="n">local_tmp_storage</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.zip_data_on_slurm_server"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.zip_data_on_slurm_server">[docs]</a>    <span class="k">def</span> <span class="nf">zip_data_on_slurm_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Zip the output folder of a job on Slurm</span>

<span class="sd">        Args:</span>
<span class="sd">            data_location (String): Folder on SLURM with the &quot;data/out&quot;</span>
<span class="sd">                subfolder.</span>
<span class="sd">            filename (String): Name to give to the zipfile.</span>
<span class="sd">            env (Dict[str, str], optional): Optional environment variables to </span>
<span class="sd">                set when running the command. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result: The result of the zip attempt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># zip</span>
        <span class="n">zip_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zip_command</span><span class="p">(</span><span class="n">data_location</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zipping </span><span class="si">{data_location}</span><span class="s2"> as </span><span class="si">{filename}</span><span class="s2"> on Slurm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">zip_cmd</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.get_zip_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_zip_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_zip_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a command string for zipping the data on Slurm.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_location (str): The folder to be zipped.</span>
<span class="sd">            filename (str): The name of the zip archive file to extract.</span>
<span class="sd">                Without extension.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The command to create the zip file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ZIP_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                                    <span class="n">data_location</span><span class="o">=</span><span class="n">data_location</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlurmClient.get_logfile_from_slurm"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_logfile_from_slurm">[docs]</a>    <span class="k">def</span> <span class="nf">get_logfile_from_slurm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">slurm_job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">local_tmp_storage</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
                               <span class="n">logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">TransferResult</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Copy the logfile of the given SLURM job to the local server.</span>

<span class="sd">        Note about (Transfer)Result:</span>

<span class="sd">        Unlike similar classes such as invoke.runners.Result</span>
<span class="sd">        or fabric.runners.Result</span>
<span class="sd">        (which have a concept of “warn and return anyways on failure”)</span>
<span class="sd">        this class has no useful truthiness behavior.</span>
<span class="sd">        If a file transfer fails, some exception will be raised,</span>
<span class="sd">        either an OSError or an error from within Paramiko.</span>

<span class="sd">        Args:</span>
<span class="sd">            slurm_job_id (str): The ID of the SLURM job.</span>
<span class="sd">            local_tmp_storage (str, optional): Path to store the logfile </span>
<span class="sd">                locally. Defaults to &quot;/tmp/&quot;.</span>
<span class="sd">            logfile (str, optional): Path to the logfile on the SLURM server.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple: directory, full path of the logfile, and TransferResult</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOGFILE</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_job_id</span><span class="o">=</span><span class="n">slurm_job_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying logfile </span><span class="si">{logfile}</span><span class="s2"> from Slurm</span><span class="se">\</span>
<span class="s2">            to </span><span class="si">{local_tmp_storage}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">remote</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span>
            <span class="n">local</span><span class="o">=</span><span class="n">local_tmp_storage</span><span class="p">)</span>
        <span class="n">export_file</span> <span class="o">=</span> <span class="n">local_tmp_storage</span><span class="o">+</span><span class="n">logfile</span>
        <span class="k">return</span> <span class="n">local_tmp_storage</span><span class="p">,</span> <span class="n">export_file</span><span class="p">,</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SlurmClient.get_unzip_command"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_unzip_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_unzip_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">filter_filetypes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;*.zarr *.tiff *.tif&quot;</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a command string for unzipping a data archive and creating</span>
<span class="sd">        required directories for Slurm jobs.</span>

<span class="sd">        Args:</span>
<span class="sd">            zipfile (str): The name of the zip archive file to extract.</span>
<span class="sd">                Without extension.</span>
<span class="sd">            filter_filetypes (str, optional): A space-separated string</span>
<span class="sd">                containing the file extensions to extract from the zip file.</span>
<span class="sd">                E.g. defaults to &quot;*.zarr *.tiff *.tif&quot;.</span>
<span class="sd">                Setting this argument to `None` will omit the file</span>
<span class="sd">                filter and extract all files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str:</span>
<span class="sd">                The command to extract the specified</span>
<span class="sd">                filetypes from the zip file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unzip_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mkdir </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="s2">/data</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="s2">/data/in</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="s2">/data/out</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="s2">/data/gt</span><span class="se">\&quot;</span><span class="s2">; </span><span class="se">\</span>
<span class="s2">                    7z x -y -o</span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="s2">/data/in</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="se">\&quot;</span><span class="si">{self.slurm_data_path}</span><span class="s2">/</span><span class="si">{zipfile}</span><span class="s2">.zip</span><span class="se">\&quot;</span><span class="s2"> </span><span class="si">{filter_filetypes}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">unzip_cmd</span></div>

<div class="viewcode-block" id="SlurmClient.get_image_versions_and_data_files"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_image_versions_and_data_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_versions_and_data_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
                                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the available image versions and input data files for a</span>
<span class="sd">        given model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): The name of the model to query for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[str], List[str]]:</span>
<span class="sd">                A tuple containing two lists:</span>
<span class="sd">                - The first list includes the available image versions, </span>
<span class="sd">                    sorted in descending order.</span>
<span class="sd">                - The second list includes the available data files.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the provided model is not found in the</span>
<span class="sd">                SlurmClient&#39;s known model paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No path known for provided model </span><span class="si">{model}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">                    in </span><span class="si">{self.slurm_model_paths}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cmdlist</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_VERSION_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_images_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span><span class="p">,</span>
                                     <span class="n">image_path</span><span class="o">=</span><span class="n">image_path</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_DATA_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slurm_data_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_data_path</span><span class="p">)]</span>
        <span class="c1"># split responses per command</span>
        <span class="n">response_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands_split_out</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">)</span>
        <span class="c1"># split lines further into sublists</span>
        <span class="n">response_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">response_list</span><span class="p">]</span>
        <span class="n">response_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">response_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">response_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="SlurmClient.get_all_image_versions_and_data_files"><a class="viewcode-back" href="../../biomero.html#biomero.slurm_client.SlurmClient.get_all_image_versions_and_data_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_image_versions_and_data_files</span><span class="p">(</span><span class="bp">self</span>
                                              <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                                                         <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve all available image versions and data files from</span>
<span class="sd">        the Slurm cluster.</span>

<span class="sd">        Returns:</span>
<span class="sd">           Tuple[Dict[str, List[str]], List[str]]:</span>
<span class="sd">                A tuple containing:</span>
<span class="sd">                - A dictionary mapping models to available versions.</span>
<span class="sd">                - A list of available input data folders.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resultdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cmdlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">pathcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VERSION_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">slurm_images_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_images_path</span><span class="p">,</span>
                <span class="n">image_path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="n">cmdlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pathcmd</span><span class="p">)</span>

        <span class="c1"># Add data path too</span>
        <span class="n">cmdlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DATA_CMD</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">slurm_data_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_data_path</span><span class="p">))</span>

        <span class="c1"># Split responses per command</span>
        <span class="n">response_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands_split_out</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">)</span>

        <span class="c1"># Split lines further into sublists</span>
        <span class="n">response_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">response_list</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_model_paths</span><span class="p">):</span>
            <span class="c1"># Return highest version first</span>
            <span class="n">resultdict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">response_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resultdict</span><span class="p">,</span> <span class="n">response_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, T.T.Luik.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>